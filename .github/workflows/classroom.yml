name: Autograding Tests
on:
  - push
  - repository_dispatch
permissions:
  checks: write
  actions: read
  contents: read

jobs:
  run-autograding-tests:
    name: ÐžÑ†ÐµÐ½Ð¸Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ð´Ð°Ð½Ð¸Ð¹
    runs-on: ubuntu-latest
    if: github.actor != 'github-classroom[bot]'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    # ============ Ð—ÐÐŸÐ£Ð¡Ðš Ð’Ð¡Ð•Ð¥ Ð¢Ð•Ð¡Ð¢ÐžÐ’ ============
    - name: Run All Autograding Tests
      id: run_tests
      run: |
        python3 tools/run_all_tests.py

    # ============ ÐÐ“Ð Ð•Ð“ÐÐ¦Ð˜Ð¯ Ð Ð•Ð—Ð£Ð›Ð¬Ð¢ÐÐ¢ÐžÐ’ ============
    - name: Aggregate All Task Results
      id: aggregate
      run: |
        python3 tools/aggregate_all.py

    # ============ Ð¡ÐžÐ¥Ð ÐÐÐ•ÐÐ˜Ð• Ð’Ð¡Ð•Ð¥ Ð Ð•Ð—Ð£Ð›Ð¬Ð¢ÐÐ¢ÐžÐ’ ============
    - name: Save Results for Classroom & Summary
      uses: actions/upload-artifact@v4
      with:
        name: autograding-results
        path: |
          task*_aggregated.txt
          results/
        retention-days: 1

    # ============ Ð“Ð•ÐÐ•Ð ÐÐ¦Ð˜Ð¯ Ð˜Ð¢ÐžÐ“ÐžÐ’ÐžÐ“Ðž ÐžÐ¢Ð§ÐÐ¢Ð Ð”Ð›Ð¯ Ð¡Ð¢Ð£Ð”Ð•ÐÐ¢Ð ============
    - name: âœ… Generate Final Summary (visible in Actions tab)
      if: always()
      run: |
        python3 tools/report_summary.py --generate-summary


  # JOB 2: ÐžÐ¢ÐŸÐ ÐÐ’ÐšÐ Ð’ GITHUB CLASSROOM (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ ÑƒÑ‡Ð¸Ñ‚ÐµÐ»Ñ)
  report-to-classroom:
    name: ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð² Ð² GitHub Classroom
    runs-on: ubuntu-latest
    needs: run-autograding-tests
    if: always()  # ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚ Ð½Ðµ Ñ€ÐµÑˆÐ¸Ð» Ð²ÑÑ‘
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download Autograding Results
      uses: actions/download-artifact@v4
      with:
        name: autograding-results
        path: ./

    - name: Prepare Outputs for Classroom
      id: extract_results
      run: |
        python3 tools/report_summary.py --extract --output-env

    - name: ðŸ“¤ Report to GitHub Classroom
      uses: classroom-resources/autograding-grading-reporter@v1
      env:
        TASK_01_RESULTS: "${{ steps.extract_results.outputs.task_01_aggregated }}"
        TASK_02_RESULTS: "${{ steps.extract_results.outputs.task_02_aggregated }}"
        TASK_01_REFACTOR_RESULTS: "${{ steps.extract_results.outputs.task_01_refactor_aggregated }}"
        TASK_02_REFACTOR_RESULTS: "${{ steps.extract_results.outputs.task_02_refactor_aggregated }}"
        # ðŸ‘† ÐŸÑ€Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ð¸ Ð·Ð°Ð´Ð°Ñ‡ â€” Ð´Ð¾Ð±Ð°Ð²ÑŒ ÑÑŽÐ´Ð° Ð½Ð¾Ð²Ñ‹Ðµ ÑÑ‚Ñ€Ð¾ÐºÐ¸: TASK_04_RESULTS: ...
      with:
        runners: "task_01,task_02,task_01_refactor,task_02_refactor"  # ðŸ‘ˆ Ð¸ ÑÑŽÐ´Ð°: task_04


  # JOB 3: ÐÐÐÐ›Ð˜Ð— ÐšÐÐ§Ð•Ð¡Ð¢Ð’Ð ÐšÐžÐ”Ð
  code-quality-analysis:
    name: ÐÐ½Ð°Ð»Ð¸Ð· ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð° ÐºÐ¾Ð´Ð°
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install linters
      run: |
        pip install pylint flake8 ruff -q

    - name: Run code analysis
      run: |
        python3 tools/code_analysis.py >> $GITHUB_STEP_SUMMARY
